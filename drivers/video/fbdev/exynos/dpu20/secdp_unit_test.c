/*
 * Copyright (c) 2017, The Linux Foundation. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
 * only version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 */

#include "displayport.h"
#include "secdp_unit_test.h"

int test_edid_support_cnt = 17;
struct v4l2_dv_timings test_edid_max_video = V4L2_DV_BT_CEA_3840X2160P60;

static u8 g_test_edid[] = {
	0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x09, 0xD1, 0x54, 0x7F, 0x45, 0x54, 0x00, 0x00,
	0x14, 0x1B, 0x01, 0x03, 0x80, 0x46, 0x28, 0x78, 0x2E, 0xDF, 0x50, 0xA3, 0x54, 0x35, 0xB5, 0x26,
	0x0F, 0x50, 0x54, 0xA5, 0x6B, 0x80, 0xD1, 0xC0, 0x81, 0xC0, 0x81, 0x00, 0x81, 0x80, 0xA9, 0xC0,
	0xB3, 0x00, 0x01, 0x01, 0x01, 0x01, 0x51, 0xD0, 0x00, 0xA0, 0xF0, 0x70, 0x3E, 0x80, 0x30, 0x20,
	0x35, 0x00, 0xBA, 0x89, 0x21, 0x00, 0x00, 0x1A, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x53, 0x35, 0x48,
	0x30, 0x31, 0x38, 0x39, 0x31, 0x53, 0x4C, 0x30, 0x0A, 0x20, 0x00, 0x00, 0x00, 0xFD, 0x00, 0x18,
	0x4C, 0x1E, 0x8C, 0x3C, 0x00, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0xFC,
	0x00, 0x42, 0x65, 0x6E, 0x51, 0x20, 0x53, 0x57, 0x33, 0x32, 0x30, 0x0A, 0x20, 0x20, 0x01, 0x42,
	0x02, 0x03, 0x45, 0xF1, 0x56, 0x61, 0x60, 0x5D, 0x5E, 0x5F, 0x10, 0x05, 0x04, 0x03, 0x02, 0x07,
	0x06, 0x0F, 0x1F, 0x20, 0x21, 0x22, 0x14, 0x13, 0x12, 0x16, 0x01, 0x23, 0x09, 0x07, 0x07, 0xE6,
	0x06, 0x05, 0x01, 0x60, 0x5A, 0x44, 0x6D, 0x03, 0x0C, 0x00, 0x10, 0x00, 0x38, 0x44, 0x20, 0x00,
	0x60, 0x01, 0x02, 0x03, 0x67, 0xD8, 0x5D, 0xC4, 0x01, 0x78, 0x80, 0x01, 0xE4, 0x0F, 0x03, 0x00,
	0x00, 0xE3, 0x05, 0xC3, 0x00, 0x02, 0x3A, 0x80, 0x18, 0x71, 0x38, 0x2D, 0x40, 0x58, 0x2C, 0x45,
	0x00, 0xBA, 0x89, 0x21, 0x00, 0x00, 0x1E, 0x56, 0x5E, 0x00, 0xA0, 0xA0, 0xA0, 0x29, 0x50, 0x30,
	0x20, 0x35, 0x00, 0xBA, 0x89, 0x21, 0x00, 0x00, 0x1A, 0xF4, 0x51, 0x00, 0xA0, 0xF0, 0x70, 0x19,
	0x80, 0x30, 0x20, 0x35, 0x00, 0xBA, 0x89, 0x21, 0x00, 0x00, 0x1E, 0x00, 0x00, 0x00, 0x00, 0xAB,
};

int secdp_unit_test_edid_parse(void)
{
	struct displayport_device *displayport = get_displayport_drvdata();

	int i, support_cnt = 0;
	u64 max_pclk = supported_videos[EDID_DEFAULT_TIMINGS_IDX].dv_timings.bt.pixelclock;
	int ret = 0;

	displayport->do_unit_test = 1;
	displayport_info("unit test edid parse\n");

	ret = edid_update(displayport);
	if (ret < 0)
		displayport_err("failed to update edid in unit test\n");

	for (i = 0; i < supported_videos_pre_cnt; i++) {
		if (supported_videos[i].edid_support_match == true) {
			displayport_info("unit test supported_videos : %s\n", supported_videos[i].name);
			support_cnt++;
		}
	}

	if (support_cnt != test_edid_support_cnt) {
		displayport_err("unit test support count is not mattching, %d, %d\n",
				support_cnt, test_edid_support_cnt);
		ret = false;
		goto exit;
	}

	for (i = supported_videos_pre_cnt - 1; i > 0; i--) {
		if (supported_videos[i].edid_support_match) {
			displayport_info("max video_format : %s\n",	supported_videos[i].name);
			max_pclk = supported_videos[i].dv_timings.bt.pixelclock;
			break;
		}
	}

	if (max_pclk == test_edid_max_video.bt.pixelclock) {
		ret = true;
		goto exit;
	}

exit:
	displayport_info("returns %s\n", ret ? "true" : "false");
	displayport->do_unit_test = 0;
	return ret;
}

int edid_read_unit(u8 **data)
{
	int block_cnt;

	block_cnt = g_test_edid[EDID_EXTENSION_FLAG] + 1;
	*data = g_test_edid;

	return block_cnt;
}
